# GalleryCRM 기능 상세 정의 및 정책 설계서

## 목차
1. [시스템 개요](#시스템-개요)
2. [사용자 역할 및 권한](#사용자-역할-및-권한)
3. [핵심 기능 상세 정의](#핵심-기능-상세-정의)
4. [비즈니스 정책 및 규칙](#비즈니스-정책-및-규칙)
5. [데이터 접근 제어 정책](#데이터-접근-제어-정책)
6. [승인 워크플로우](#승인-워크플로우)
7. [보안 정책](#보안-정책)
8. [데이터 보존 정책](#데이터-보존-정책)
9. [감사 및 로깅 정책](#감사-및-로깅-정책)

---

## 시스템 개요

### 목적
GalleryCRM은 갤러리 내부용 CRM 시스템으로, 고객, 작가, 거래 정보를 안전하고 효율적으로 관리하기 위한 사내 전용 시스템입니다.

### 핵심 가치
- **보안**: 역할 기반 데이터 접근 제어 및 마스킹
- **투명성**: 모든 중요 행위의 감사 로그 기록
- **효율성**: 승인 워크플로우를 통한 데이터 품질 관리
- **추적성**: 엔티티 변경 이력 완전 추적

---

## 사용자 역할 및 권한

### 역할 정의

#### 1. MASTER (마스터 관리자)
- **설명**: 시스템 최고 관리자
- **권한**:
  - 모든 데이터 전체 접근 (마스킹 없음)
  - 모든 승인 권한 (고객, 작가, 거래, 열람 요청)
  - 사용자 및 팀 관리
  - 시스템 설정 관리
  - 모든 감사 로그 조회

#### 2. ADMIN (관리자)
- **설명**: 일반 관리자
- **권한**:
  - 모든 데이터 전체 접근 (마스킹 없음)
  - 모든 승인 권한 (고객, 작가, 거래, 열람 요청)
  - 사용자 및 팀 관리 (본인 제외)
  - 모든 감사 로그 조회
  - 본인 역할 및 활성화 상태 변경 불가

#### 3. MANAGER (팀장)
- **설명**: 팀 단위 관리자
- **권한**:
  - 본인 팀 데이터 전체 접근 (마스킹 없음)
  - 타 팀 데이터 접근 불가
  - 본인 팀 데이터 승인 권한 (고객, 작가, 거래)
  - 본인 팀 열람 요청 승인 권한
  - 본인 팀 사원 관리 (생성, 수정)
  - 본인 팀 감사 로그 조회

#### 4. STAFF (사원)
- **설명**: 일반 사용자
- **권한**:
  - 본인 생성 데이터 전체 접근
  - 본인 팀 데이터 부분 접근 (마스킹 적용)
  - 타 팀 데이터 접근 불가
  - 데이터 생성 및 수정 (승인 전까지)
  - 열람 요청 생성 가능
  - 승인 권한 없음

### 권한 매트릭스

| 기능 | MASTER | ADMIN | MANAGER | STAFF |
|------|--------|-------|---------|-------|
| 모든 데이터 조회 | ✅ | ✅ | ❌ | ❌ |
| 본인 팀 데이터 조회 | ✅ | ✅ | ✅ | ✅ (마스킹) |
| 타 팀 데이터 조회 | ✅ | ✅ | ❌ | ❌ |
| 데이터 생성 | ✅ | ✅ | ✅ | ✅ |
| 데이터 수정 | ✅ | ✅ | ✅ | ✅ (본인 생성만) |
| 데이터 삭제 | ✅ | ✅ | ✅ | ✅ (본인 생성만, 승인 전) |
| 승인 요청 제출 | ✅ | ✅ | ✅ | ✅ |
| 고객 승인/반려 | ✅ | ✅ | ✅ (본인 팀) | ❌ |
| 작가 승인/반려 | ✅ | ✅ | ✅ (본인 팀) | ❌ |
| 거래 승인/반려 | ✅ | ✅ | ✅ (본인 팀) | ❌ |
| 열람 요청 승인 | ✅ | ✅ | ✅ (본인 팀) | ❌ |
| 사용자 관리 | ✅ | ✅ (본인 제외) | ✅ (본인 팀 사원) | ❌ |
| 팀 관리 | ✅ | ✅ | ❌ | ❌ |
| 감사 로그 조회 | ✅ | ✅ | ✅ (본인 팀) | ✅ (본인만) |

---

## 핵심 기능 상세 정의

### 1. 고객 관리 (Customer Management)

#### 1.1 고객 등록
- **기능**: 새로운 고객 정보 등록
- **상태**: `DRAFT` (초안)
- **권한**: 모든 사용자
- **필수 정보**:
  - 이름
  - 이메일 (선택)
  - 전화번호 (선택)
  - 주소 (선택)
  - 메모 (선택)
- **자동 설정**:
  - `createdBy`: 현재 사용자 ID
  - `teamId`: 현재 사용자의 팀 ID
  - `status`: `DRAFT`
- **정책**:
  - 사용자는 반드시 팀에 소속되어 있어야 함
  - 생성 시 Audit Log 기록

#### 1.2 고객 수정
- **기능**: 등록된 고객 정보 수정
- **권한**:
  - 생성자 본인: `DRAFT`, `PENDING`, `REJECTED` 상태만 수정 가능
  - ADMIN/MASTER: 모든 상태 수정 가능
- **정책**:
  - `APPROVED` 상태는 생성자도 수정 불가 (재승인 필요)
  - 수정 시 Entity History 기록
  - 수정 시 Audit Log 기록

#### 1.3 고객 삭제
- **기능**: 고객 정보 삭제 (Soft Delete)
- **권한**:
  - 생성자 본인: `DRAFT`, `PENDING`, `REJECTED` 상태만 삭제 가능
  - ADMIN/MASTER: 모든 상태 삭제 가능
- **정책**:
  - `APPROVED` 상태는 생성자도 삭제 불가
  - Soft Delete 사용 (`isDeleted = true`)
  - 삭제 후 1년 경과 시 완전 삭제 (스케줄러)
  - 삭제 시 Audit Log 기록

#### 1.4 고객 승인 요청
- **기능**: 고객 정보 승인 요청 제출
- **상태 변경**: `DRAFT` 또는 `REJECTED` → `PENDING`
- **권한**: 생성자 본인, ADMIN, MASTER
- **정책**:
  - `APPROVED` 상태는 재승인 요청 불가
  - 승인 요청 시 Audit Log 기록

#### 1.5 고객 승인/반려
- **기능**: 고객 정보 승인 또는 반려 처리
- **상태 변경**: `PENDING` → `APPROVED` 또는 `REJECTED`
- **권한**: ADMIN, MASTER, MANAGER (본인 팀만)
- **필수 정보**:
  - 승인: 승인자 정보 자동 기록
  - 반려: 반려 사유 필수 입력
- **정책**:
  - 승인 시 `approvedBy`, `approvedAt` 기록
  - 반려 시 `rejectionReason` 필수
  - 승인/반려 시 Audit Log 기록

#### 1.6 고객 조회
- **기능**: 고객 목록 및 상세 조회
- **권한**: 역할별 데이터 접근 제어
- **검색 기능**:
  - 키워드 검색 (이름, 이메일, 전화번호)
  - 상태 필터 (DRAFT, PENDING, APPROVED, REJECTED)
  - 팀 필터
  - 날짜 범위 필터
  - 페이지네이션
- **정책**:
  - 조회 시 Audit Log 기록
  - 마스킹 레벨에 따른 데이터 표시

### 2. 작가 관리 (Artist Management)

#### 2.1 작가 등록
- **기능**: 새로운 작가 정보 등록
- **상태**: `DRAFT` (초안)
- **권한**: 모든 사용자
- **필수 정보**:
  - 이름
  - 국적 (선택)
  - 장르 (선택)
  - 소개 (선택)
- **정책**:
  - 생성 시 Audit Log 기록

#### 2.2 작가 수정
- **기능**: 등록된 작가 정보 수정
- **권한**: 생성자 본인, ADMIN, MASTER
- **정책**:
  - 수정 시 Entity History 기록
  - 수정 시 Audit Log 기록

#### 2.3 작가 승인/반려
- **기능**: 작가 정보 승인 또는 반려 처리
- **상태 변경**: `PENDING` → `APPROVED` 또는 `REJECTED`
- **권한**: ADMIN, MASTER, MANAGER (본인 팀만)
- **정책**: 고객 승인/반려와 동일

### 3. 거래 관리 (Transaction Management)

#### 3.1 거래 등록
- **기능**: 새로운 거래 정보 등록
- **상태**: `DRAFT` (초안)
- **권한**: 모든 사용자
- **필수 정보**:
  - 고객 ID (FK)
  - 작가 ID (FK)
  - 거래 금액
  - 통화
  - 거래 일자
  - 계약 조건 (선택)
- **자동 설정**:
  - `createdBy`: 현재 사용자 ID
  - `teamId`: 현재 사용자의 팀 ID
- **정책**:
  - 생성 시 Audit Log 기록

#### 3.2 거래 승인/반려
- **기능**: 거래 정보 승인 또는 반려 처리
- **상태 변경**: `PENDING` → `APPROVED` 또는 `REJECTED`
- **권한**: ADMIN, MASTER, MANAGER (본인 팀만)
- **정책**: 고객 승인/반려와 동일

### 4. 열람 요청 관리 (Access Request Management)

#### 4.1 열람 요청 생성
- **기능**: 마스킹된 데이터 열람 요청
- **대상**: 고객(CUSTOMER), 거래(TRANSACTION)
- **권한**: 모든 사용자
- **필수 정보**:
  - 대상 타입 (CUSTOMER 또는 TRANSACTION)
  - 대상 ID
  - 열람 사유
- **정책**:
  - 이미 승인된 요청이 유효한 경우 중복 요청 불가
  - 요청 시 Audit Log 기록
  - 상태: `PENDING`

#### 4.2 열람 요청 승인
- **기능**: 열람 요청 승인 처리
- **상태 변경**: `PENDING` → `APPROVED`
- **권한**: ADMIN, MASTER, MANAGER (본인 팀 요청만)
- **필수 정보**:
  - 만료 일시 (선택, 기본값: 승인일로부터 7일)
- **정책**:
  - 승인 시 `expiresAt` 설정
  - 승인 시 `approvedBy`, `approvedAt` 기록
  - 승인 시 Audit Log 기록
  - 만료 전까지 해당 데이터 전체 열람 가능

#### 4.3 열람 요청 거부
- **기능**: 열람 요청 거부 처리
- **상태 변경**: `PENDING` → `REJECTED`
- **권한**: ADMIN, MASTER, MANAGER (본인 팀 요청만)
- **필수 정보**:
  - 거부 사유 (선택)
- **정책**:
  - 거부 시 `rejectionReason` 기록
  - 거부 시 Audit Log 기록

### 5. 사용자 관리 (User Management)

#### 5.1 사용자 생성
- **기능**: 새로운 사용자 계정 생성
- **권한**: ADMIN, MASTER, MANAGER (본인 팀 사원만)
- **필수 정보**:
  - 이메일 (고유)
  - 이름
  - 역할 (ADMIN, MANAGER, STAFF)
  - 팀 (선택, MANAGER는 본인 팀 자동 설정)
  - 초기 비밀번호 (최소 6자)
- **정책**:
  - MANAGER는 본인 팀으로만 사원 등록 가능
  - 생성 시 Audit Log 기록

#### 5.2 사용자 수정
- **기능**: 사용자 정보 수정
- **권한**: ADMIN, MASTER, MANAGER (본인 팀 사원만)
- **수정 가능 항목**:
  - 역할 (본인 역할 변경 불가)
  - 팀
  - 활성화 상태 (본인 활성화 상태 변경 불가)
- **정책**:
  - 본인 정보는 역할 및 활성화 상태 변경 불가
  - 수정 시 Audit Log 기록

#### 5.3 비밀번호 초기화
- **기능**: 사용자 비밀번호 초기화
- **권한**: ADMIN, MASTER
- **정책**:
  - 새 비밀번호 입력 필요
  - 초기화 시 Audit Log 기록

### 6. 팀 관리 (Team Management)

#### 6.1 팀 생성
- **기능**: 새로운 팀 생성
- **권한**: ADMIN, MASTER
- **필수 정보**:
  - 팀 이름
  - 설명 (선택)
- **정책**:
  - 생성 시 Audit Log 기록

#### 6.2 팀 수정
- **기능**: 팀 정보 수정
- **권한**: ADMIN, MASTER
- **수정 가능 항목**:
  - 팀 이름
  - 설명
  - 활성화 상태
- **정책**:
  - 수정 시 Audit Log 기록

### 7. 대시보드 (Dashboard)

#### 7.1 통계 대시보드
- **기능**: 주요 통계 정보 표시
- **표시 항목**:
  - 총 고객 수
  - 승인 대기 고객 수
  - 대기 열람 요청 수
  - 최근 등록 작가 수 (7일)
  - 최근 활동 로그 (10개)
- **권한**: 역할별 필터링
  - STAFF: 본인 활동만
  - MANAGER: 본인 팀 활동만
  - ADMIN/MASTER: 모든 활동

### 8. 활동 로그 (Audit Logs)

#### 8.1 활동 로그 조회
- **기능**: 시스템 내 모든 중요 행위 기록 조회
- **기록 항목**:
  - CREATE: 데이터 생성
  - UPDATE: 데이터 수정
  - DELETE: 데이터 삭제
  - VIEW: 데이터 조회
  - APPROVE: 승인 처리
  - REJECT: 반려 처리
  - ACCESS_REQUEST: 열람 요청
- **필터**:
  - 사용자 ID
  - 엔티티 타입
  - 엔티티 ID
  - 날짜 범위
- **권한**: 역할별 필터링
  - STAFF: 본인 활동만
  - MANAGER: 본인 팀 활동만
  - ADMIN/MASTER: 모든 활동

---

## 비즈니스 정책 및 규칙

### 1. 데이터 상태 관리

#### 1.1 상태 전이 규칙
```
DRAFT → PENDING (승인 요청)
PENDING → APPROVED (승인)
PENDING → REJECTED (반려)
REJECTED → PENDING (재승인 요청)
APPROVED → (수정 불가, 재승인 필요)
```

#### 1.2 상태별 제약사항
- **DRAFT**: 수정/삭제 가능, 승인 요청 가능
- **PENDING**: 수정/삭제 불가, 승인/반려 대기
- **APPROVED**: 수정/삭제 불가 (ADMIN/MASTER 제외), 재승인 필요
- **REJECTED**: 수정/삭제 가능, 재승인 요청 가능

### 2. 승인 정책

#### 2.1 승인 권한
- 고객/작가/거래 승인: ADMIN, MASTER, MANAGER (본인 팀만)
- 열람 요청 승인: ADMIN, MASTER, MANAGER (본인 팀 요청만)

#### 2.2 승인 필수 정보
- 승인: 승인자 정보 자동 기록
- 반려: 반려 사유 필수 입력

#### 2.3 승인 후 처리
- 승인된 데이터는 수정 불가 (재승인 필요)
- 승인된 데이터는 삭제 불가 (ADMIN/MASTER 제외)

### 3. 데이터 소유권

#### 3.1 데이터 소유자
- 생성자: 데이터를 생성한 사용자
- 팀: 데이터가 속한 팀

#### 3.2 소유권 기반 권한
- 생성자: 본인이 생성한 데이터 수정/삭제 권한 (승인 전까지)
- 팀: 팀 데이터 조회 및 승인 권한

### 4. 열람 요청 정책

#### 4.1 요청 조건
- 마스킹된 데이터에 대해서만 요청 가능
- 이미 승인된 요청이 유효한 경우 중복 요청 불가

#### 4.2 승인 조건
- 요청자가 속한 팀의 MANAGER 이상 권한 필요
- 타 팀 요청은 ADMIN/MASTER만 승인 가능

#### 4.3 열람 기간
- 기본값: 승인일로부터 7일
- 만료 전까지 전체 데이터 열람 가능
- 만료 후 자동으로 마스킹 적용

---

## 데이터 접근 제어 정책

### 1. 마스킹 레벨

#### 1.1 NONE (마스킹 없음)
- **적용 대상**:
  - 본인이 생성한 데이터
  - 본인 팀 데이터 (MANAGER 이상)
  - 승인된 열람 요청이 유효한 데이터
- **표시**: 전체 데이터 표시

#### 1.2 PARTIAL (부분 마스킹)
- **적용 대상**:
  - 본인 팀 데이터 (STAFF)
- **마스킹 규칙**:
  - 이름: "홍길동" → "홍*동"
  - 이메일: "test@example.com" → "t***@example.com"
  - 전화번호: "010-1234-5678" → "010-****-5678"
  - 금액: "1,000,000원" → "1,***,***원"
  - 주소/메모: 앞부분 일부만 표시

#### 1.3 FULL (전체 마스킹)
- **적용 대상**:
  - 타 팀 데이터
- **마스킹 규칙**:
  - 이름: "***"
  - 이메일: "***@***.***"
  - 전화번호: "***-****-****"
  - 금액: "***원"
  - 주소/메모: "***"

### 2. 접근 제어 규칙

#### 2.1 데이터 조회
- **STAFF**:
  - 본인 생성 데이터: 전체 조회
  - 본인 팀 데이터: 부분 마스킹 조회
  - 타 팀 데이터: 접근 불가
- **MANAGER**:
  - 본인 팀 데이터: 전체 조회
  - 타 팀 데이터: 접근 불가
- **ADMIN/MASTER**:
  - 모든 데이터: 전체 조회

#### 2.2 데이터 수정
- **STAFF**: 본인 생성 데이터만 수정 가능 (승인 전까지)
- **MANAGER**: 본인 팀 데이터 수정 가능
- **ADMIN/MASTER**: 모든 데이터 수정 가능

#### 2.3 데이터 삭제
- **STAFF**: 본인 생성 데이터만 삭제 가능 (승인 전까지)
- **MANAGER**: 본인 팀 데이터 삭제 가능 (승인 전까지)
- **ADMIN/MASTER**: 모든 데이터 삭제 가능

---

## 승인 워크플로우

### 1. 고객/작가/거래 승인 워크플로우

```
1. 사용자가 데이터 생성 (DRAFT)
   ↓
2. 사용자가 승인 요청 제출 (PENDING)
   ↓
3. MANAGER/ADMIN/MASTER가 승인 또는 반려 처리
   ├─ 승인 → APPROVED (수정 불가)
   └─ 반려 → REJECTED (수정 후 재승인 가능)
```

### 2. 열람 요청 승인 워크플로우

```
1. 사용자가 열람 요청 생성 (PENDING)
   ↓
2. MANAGER/ADMIN/MASTER가 승인 또는 거부 처리
   ├─ 승인 → APPROVED (만료일시 설정, 전체 열람 가능)
   └─ 거부 → REJECTED
   ↓
3. 만료일시 도달 시 자동으로 마스킹 재적용
```

---

## 보안 정책

### 1. 인증 및 인가

#### 1.1 인증
- JWT 기반 토큰 인증
- 토큰 만료 시간: 24시간
- 토큰 갱신: 로그인 시 자동 갱신

#### 1.2 인가
- 역할 기반 접근 제어 (RBAC)
- API 레벨 권한 검증
- 데이터 레벨 접근 제어

### 2. 데이터 보호

#### 2.1 암호화
- 비밀번호: bcrypt 해시 암호화
- 민감 데이터: 마스킹 처리

#### 2.2 접근 제어
- 역할 기반 데이터 접근 제어
- 팀 단위 데이터 격리
- 열람 요청 기반 임시 접근 허용

### 3. 감사 및 모니터링

#### 3.1 감사 로그
- 모든 중요 행위 기록
- 변경 이력 추적
- 접근 이력 기록

#### 3.2 모니터링
- 비정상 접근 패턴 감지
- 대량 데이터 조회 감지
- 승인 프로세스 모니터링

---

## 데이터 보존 정책

### 1. 데이터 삭제 정책

#### 1.1 Soft Delete
- 모든 삭제는 Soft Delete 사용
- `isDeleted = true` 플래그 설정
- 실제 데이터는 보존

#### 1.2 완전 삭제
- 삭제 후 1년 경과 시 완전 삭제
- 스케줄러를 통한 자동 정리
- Audit Log는 영구 보존

### 2. 로그 보존 정책

#### 2.1 Audit Log
- 영구 보존
- 삭제 불가
- 감사 목적 보존

#### 2.2 Entity History
- 영구 보존
- 삭제 불가
- 변경 이력 추적 목적

### 3. 백업 정책

#### 3.1 데이터베이스 백업
- 일일 자동 백업 권장
- 백업 보존 기간: 30일
- 재해 복구 계획 수립

---

## 감사 및 로깅 정책

### 1. 감사 로그 기록 항목

#### 1.1 필수 기록 항목
- CREATE: 데이터 생성
- UPDATE: 데이터 수정
- DELETE: 데이터 삭제
- VIEW: 데이터 조회
- APPROVE: 승인 처리
- REJECT: 반려 처리
- ACCESS_REQUEST: 열람 요청

#### 1.2 기록 정보
- 사용자 ID
- 행위 타입
- 엔티티 타입 및 ID
- 변경 전/후 값 (JSON)
- IP 주소
- User Agent
- 타임스탬프

### 2. 변경 이력 추적

#### 2.1 추적 대상
- Customer (고객)
- Transaction (거래)

#### 2.2 추적 정보
- 필드명
- 변경 전 값
- 변경 후 값
- 변경자
- 변경 시각

### 3. 로그 접근 권한

#### 3.1 조회 권한
- STAFF: 본인 활동만
- MANAGER: 본인 팀 활동만
- ADMIN/MASTER: 모든 활동

#### 3.2 수정/삭제 권한
- 모든 로그는 수정/삭제 불가
- 영구 보존

---

## 부록

### A. 상태 코드 정의

#### A.1 CustomerStatus
- `DRAFT`: 초안
- `PENDING`: 승인 대기
- `APPROVED`: 승인됨
- `REJECTED`: 반려됨

#### A.2 AccessRequestStatus
- `PENDING`: 승인 대기
- `APPROVED`: 승인됨
- `REJECTED`: 거부됨

#### A.3 UserRole
- `MASTER`: 마스터 관리자
- `ADMIN`: 관리자
- `MANAGER`: 팀장
- `STAFF`: 사원

### B. 마스킹 규칙 상세

#### B.1 이름 마스킹
- PARTIAL: 첫 글자 + 중간 마스킹 + 마지막 글자
- FULL: "***"

#### B.2 이메일 마스킹
- PARTIAL: 첫 글자 + 마스킹 + 도메인
- FULL: "***@***.***"

#### B.3 전화번호 마스킹
- PARTIAL: 앞 3자리 + 마스킹 + 뒤 4자리
- FULL: "***-****-****"

#### B.4 금액 마스킹
- PARTIAL: 첫 번째 구간 + 마스킹
- FULL: "***원"

### C. 에러 처리 정책

#### C.1 에러 코드
- `400`: 잘못된 요청
- `401`: 인증 실패
- `403`: 권한 없음
- `404`: 리소스 없음
- `500`: 서버 오류

#### C.2 에러 메시지
- 사용자 친화적 메시지 제공
- 기술적 세부사항은 로그에만 기록
- 다국어 지원 (향후)

---

**문서 버전**: 1.0  
**최종 수정일**: 2026-02-04  
**작성자**: GalleryCRM 개발팀

